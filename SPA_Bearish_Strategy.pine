//@version=6
indicator("SPA Bearish Strategy by Trade Sci", overlay=true, max_lines_count=500, max_boxes_count=500, max_labels_count=500)

// ═══════════════════════════════════════════════════════════════════════════════
// INPUT SETTINGS
// ═══════════════════════════════════════════════════════════════════════════════

// Swing Detection Settings
swingLength = input.int(10, "Swing Detection Length", minval=5, maxval=50, group="Market Structure")
showStructure = input.bool(true, "Show Market Structure (LL/LH)", group="Market Structure")

// Supply Zone Settings
zonePipsBuffer = input.float(15, "Supply Zone Buffer (Pips)", minval=5, maxval=50, step=5, group="Supply Zone")
showZones = input.bool(true, "Show Supply Zones", group="Supply Zone")
zoneColor = input.color(color.new(color.red, 85), "Supply Zone Color", group="Supply Zone")

// Candlestick Pattern Settings
enablePinBar = input.bool(true, "Enable Bearish Pin Bar", group="Candlestick Patterns")
enableEngulfing = input.bool(true, "Enable Bearish Engulfing", group="Candlestick Patterns")
enableEveningStar = input.bool(true, "Enable Evening Star", group="Candlestick Patterns")
pinBarRatio = input.float(2.5, "Pin Bar Wick/Body Ratio", minval=1.5, maxval=5.0, step=0.1, group="Candlestick Patterns")

// RSI Filter
rsiLength = input.int(14, "RSI Length", minval=5, maxval=50, group="RSI Filter")
rsiThreshold = input.int(60, "RSI Threshold (must be below)", minval=50, maxval=70, group="RSI Filter")
showRSI = input.bool(false, "Show RSI Line", group="RSI Filter")

// Risk Management
riskRewardRatio = input.float(2.0, "Risk:Reward Ratio", minval=1.0, maxval=5.0, step=0.1, group="Risk Management")
slPipsBuffer = input.float(2, "Stop Loss Buffer (Pips)", minval=1, maxval=10, step=0.5, group="Risk Management")

// Visual Settings
showEntryLabels = input.bool(true, "Show Entry Signals", group="Visuals")
showSLTP = input.bool(true, "Show SL/TP Lines", group="Visuals")
labelSize = input.string("small", "Label Size", options=["tiny", "small", "normal", "large"], group="Visuals")

// ═══════════════════════════════════════════════════════════════════════════════
// HELPER FUNCTIONS
// ═══════════════════════════════════════════════════════════════════════════════

// Convert pips to price
pipsToPrice(pips) =>
    pipValue = syminfo.mintick * 10
    if str.contains(syminfo.currency, "JPY")
        pipValue := syminfo.mintick * 100
    pips * pipValue

// Calculate RSI
rsi = ta.rsi(close, rsiLength)

// ═══════════════════════════════════════════════════════════════════════════════
// SWING DETECTION (PIVOT POINTS)
// ═══════════════════════════════════════════════════════════════════════════════

pivotHigh = ta.pivothigh(high, swingLength, swingLength)
pivotLow = ta.pivotlow(low, swingLength, swingLength)

// Store swing points
var float lastLH = na
var float lastLL = na
var int lastLHBar = na
var int lastLLBar = na
var float prevLH = na
var float prevLL = na

// Update Lower Highs (LH)
if not na(pivotHigh)
    if na(lastLH) or pivotHigh < lastLH
        prevLH := lastLH
        lastLH := pivotHigh
        lastLHBar := bar_index - swingLength
    else if pivotHigh > lastLH
        // Trend might be reversing, but we keep the last valid LH
        prevLH := lastLH

// Update Lower Lows (LL)
if not na(pivotLow)
    if na(lastLL) or pivotLow < lastLL
        prevLL := lastLL
        lastLL := pivotLow
        lastLLBar := bar_index - swingLength
    else if pivotLow > lastLL
        // Trend might be reversing
        na

// ═══════════════════════════════════════════════════════════════════════════════
// TREND DETERMINATION
// ═══════════════════════════════════════════════════════════════════════════════

// Downtrend = Lower Lows (LL) + Lower Highs (LH)
// Price must be below last Lower High
isDowntrend = not na(lastLH) and not na(lastLL) and not na(prevLH) and lastLH < prevLH and close < lastLH

// Visualize market structure
if showStructure and not na(lastLH) and bar_index - lastLHBar < 100
    label.new(lastLHBar, lastLH, "LH",
              style=label.style_label_down,
              color=color.new(color.red, 30),
              textcolor=color.white,
              size=size.tiny)

if showStructure and not na(lastLL) and bar_index - lastLLBar < 100
    label.new(lastLLBar, lastLL, "LL",
              style=label.style_label_up,
              color=color.new(color.red, 30),
              textcolor=color.white,
              size=size.tiny)

// ═══════════════════════════════════════════════════════════════════════════════
// SUPPLY ZONE DETECTION
// ═══════════════════════════════════════════════════════════════════════════════

// Supply Zone = Last Lower High ± buffer
var box supplyZoneBox = na
var float supplyZoneTop = na
var float supplyZoneBottom = na
var int supplyZoneBar = na

if not na(lastLH) and lastLHBar != supplyZoneBar
    // Create new supply zone
    pipsBuffer = pipsToPrice(zonePipsBuffer)
    supplyZoneTop := lastLH + pipsBuffer
    supplyZoneBottom := lastLH - pipsBuffer
    supplyZoneBar := lastLHBar

    // Draw supply zone box
    if showZones
        if not na(supplyZoneBox)
            box.delete(supplyZoneBox)
        supplyZoneBox := box.new(
            left=lastLHBar,
            top=supplyZoneTop,
            right=bar_index + 20,
            bottom=supplyZoneBottom,
            border_color=color.red,
            bgcolor=zoneColor,
            border_width=1,
            extend=extend.right)

// Update box right edge
if showZones and not na(supplyZoneBox)
    box.set_right(supplyZoneBox, bar_index + 20)

// Check if price is in supply zone
inSupplyZone = not na(supplyZoneTop) and not na(supplyZoneBottom) and close >= supplyZoneBottom and close <= supplyZoneTop

// ═══════════════════════════════════════════════════════════════════════════════
// CANDLESTICK PATTERN DETECTION
// ═══════════════════════════════════════════════════════════════════════════════

// Candle components
bodySize = math.abs(close - open)
upperWick = high - math.max(close, open)
lowerWick = math.min(close, open) - low
totalRange = high - low
isBearish = close < open
isBullish = close > open

// 1. Bearish Pin Bar (Shooting Star)
// - Long upper wick (at least 2.5x body size)
// - Small body in lower part
// - Minimal lower wick
bearishPinBar = enablePinBar and isBearish and upperWick > bodySize * pinBarRatio and lowerWick < bodySize * 0.3 and bodySize > 0

// 2. Bearish Engulfing
// - Previous candle is bullish
// - Current candle is bearish and engulfs previous
bearishEngulfing = enableEngulfing and isBearish and isBullish[1] and close < open[1] and open > close[1] and bodySize > bodySize[1] * 0.8

// 3. Evening Star (3-candle pattern)
// - Candle 1: Strong bullish
// - Candle 2: Small body (doji/spinning top)
// - Candle 3: Strong bearish closing below candle 1's midpoint
eveningStar = enableEveningStar and isBullish[2] and bodySize[2] > totalRange[2] * 0.6 and bodySize[1] < totalRange[1] * 0.3 and isBearish and bodySize > totalRange * 0.6 and close < (open[2] + close[2]) / 2

// Combined pattern signal
bearishPattern = bearishPinBar or bearishEngulfing or eveningStar

// ═══════════════════════════════════════════════════════════════════════════════
// ENTRY SIGNAL LOGIC
// ═══════════════════════════════════════════════════════════════════════════════

// All conditions must be met:
// 1. Downtrend confirmed (LL/LH structure)
// 2. Price pulled back into supply zone
// 3. Bearish candlestick pattern formed
// 4. RSI filter (RSI < threshold, avoiding overbought)
// 5. Candle closed (confirmation)

entrySignal = isDowntrend and inSupplyZone and bearishPattern and rsi < rsiThreshold and barstate.isconfirmed

// Track if we already have an open signal
var bool signalActive = false
var int signalBar = na
var float entryPrice = na
var float stopLoss = na
var float takeProfit = na

// Generate new signal
if entrySignal and not signalActive
    signalActive := true
    signalBar := bar_index
    entryPrice := close

    // Calculate Stop Loss (above supply zone)
    slBuffer = pipsToPrice(slPipsBuffer)
    stopLoss := supplyZoneTop + slBuffer

    // Calculate Take Profit (1:2 RR)
    riskPips = stopLoss - entryPrice
    takeProfit := entryPrice - (riskPips * riskRewardRatio)

    // Create entry label
    if showEntryLabels
        labelSizeEnum = labelSize == "tiny" ? size.tiny :
                        labelSize == "small" ? size.small :
                        labelSize == "normal" ? size.normal : size.large

        patternName = bearishPinBar ? "Pin Bar" :
                      bearishEngulfing ? "Engulfing" :
                      eveningStar ? "Evening Star" : "Pattern"

        label.new(bar_index, high,
                  text="SHORT\n" + patternName + "\n" + str.tostring(rsi, "#.0"),
                  style=label.style_label_down,
                  color=color.new(color.red, 0),
                  textcolor=color.white,
                  size=labelSizeEnum)

// Reset signal if price hits SL or TP
if signalActive
    if high >= stopLoss or low <= takeProfit or (bar_index - signalBar) > 100
        signalActive := false
        entryPrice := na
        stopLoss := na
        takeProfit := na

// ═══════════════════════════════════════════════════════════════════════════════
// VISUALIZE SL/TP LEVELS
// ═══════════════════════════════════════════════════════════════════════════════

var line slLine = na
var line tpLine = na
var line entryLine = na

if showSLTP and signalActive
    // Delete old lines
    if not na(slLine)
        line.delete(slLine)
    if not na(tpLine)
        line.delete(tpLine)
    if not na(entryLine)
        line.delete(entryLine)

    // Draw new lines
    slLine := line.new(signalBar, stopLoss, bar_index + 10, stopLoss,
                       color=color.new(color.red, 0), width=2, style=line.style_solid,
                       extend=extend.right)

    tpLine := line.new(signalBar, takeProfit, bar_index + 10, takeProfit,
                       color=color.new(color.green, 0), width=2, style=line.style_solid,
                       extend=extend.right)

    entryLine := line.new(signalBar, entryPrice, bar_index + 10, entryPrice,
                          color=color.new(color.orange, 0), width=1, style=line.style_dashed,
                          extend=extend.right)

// Update line positions
if showSLTP and signalActive
    if not na(slLine)
        line.set_x2(slLine, bar_index + 10)
    if not na(tpLine)
        line.set_x2(tpLine, bar_index + 10)
    if not na(entryLine)
        line.set_x2(entryLine, bar_index + 10)

// Clean up lines when signal ends
if not signalActive
    if not na(slLine)
        line.delete(slLine)
        slLine := na
    if not na(tpLine)
        line.delete(tpLine)
        tpLine := na
    if not na(entryLine)
        line.delete(entryLine)
        entryLine := na

// ═══════════════════════════════════════════════════════════════════════════════
// PLOTS & ALERTS
// ═══════════════════════════════════════════════════════════════════════════════

// Plot RSI in separate pane (optional)
plot(showRSI ? rsi : na, "RSI", color=color.purple, linewidth=2)
hline(showRSI ? rsiThreshold : na, "RSI Threshold", color=color.red, linestyle=hline.style_dashed)

// Background color for downtrend
bgcolor(isDowntrend ? color.new(color.red, 95) : na, title="Downtrend Background")

// Plot shapes for quick visual confirmation
plotshape(entrySignal, "Entry Signal", shape.triangledown, location.abovebar,
          color=color.new(color.red, 0), size=size.small)

// Alerts
alertcondition(entrySignal, title="SPA Bearish Entry Signal",
               message="SPA BEARISH: Entry signal detected on {{ticker}} at {{close}}")

// ═══════════════════════════════════════════════════════════════════════════════
// DASHBOARD (Optional - Summary Info)
// ═══════════════════════════════════════════════════════════════════════════════

var table dashboard = table.new(position.top_right, 2, 6,
                                 bgcolor=color.new(color.black, 80),
                                 border_width=1,
                                 border_color=color.gray)

if barstate.islast
    table.cell(dashboard, 0, 0, "SPA Bearish", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.red, 70))
    table.cell(dashboard, 1, 0, "", bgcolor=color.new(color.red, 70))

    table.cell(dashboard, 0, 1, "Trend", text_color=color.gray)
    table.cell(dashboard, 1, 1, isDowntrend ? "DOWN ✓" : "N/A",
               text_color=isDowntrend ? color.lime : color.gray)

    table.cell(dashboard, 0, 2, "In Zone", text_color=color.gray)
    table.cell(dashboard, 1, 2, inSupplyZone ? "YES ✓" : "NO",
               text_color=inSupplyZone ? color.lime : color.gray)

    table.cell(dashboard, 0, 3, "Pattern", text_color=color.gray)
    table.cell(dashboard, 1, 3, bearishPattern ? "YES ✓" : "NO",
               text_color=bearishPattern ? color.lime : color.gray)

    table.cell(dashboard, 0, 4, "RSI", text_color=color.gray)
    table.cell(dashboard, 1, 4, str.tostring(rsi, "#.0") + " " + (rsi < rsiThreshold ? "✓" : "✗"),
               text_color=rsi < rsiThreshold ? color.lime : color.gray)

    table.cell(dashboard, 0, 5, "Signal", text_color=color.gray)
    table.cell(dashboard, 1, 5, signalActive ? "ACTIVE" : "---",
               text_color=signalActive ? color.yellow : color.gray,
               bgcolor=signalActive ? color.new(color.red, 80) : na)

// ═══════════════════════════════════════════════════════════════════════════════
// END OF INDICATOR
// ═══════════════════════════════════════════════════════════════════════════════
